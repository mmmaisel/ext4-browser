From f78dde07e6ea6ccb45950029ab66eb1de695f565 Mon Sep 17 00:00:00 2001
From: Max <max.maisel@posteo.de>
Date: Thu, 1 Mar 2018 17:28:40 +0100
Subject: [PATCH 5/6] ext4_mbr: Added "disk_id" parameter to MBR creation
 function

---
 include/ext4_mbr.h | 2 +-
 src/ext4_mbr.c     | 6 ++++--
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/include/ext4_mbr.h b/include/ext4_mbr.h
index e9c5f75..97a4459 100644
--- a/include/ext4_mbr.h
+++ b/include/ext4_mbr.h
@@ -60,7 +60,7 @@ struct ext4_mbr_parts {
 	uint8_t division[4];
 };
 
-int ext4_mbr_write(struct ext4_blockdev *parent, struct ext4_mbr_parts *parts);
+int ext4_mbr_write(struct ext4_blockdev *parent, struct ext4_mbr_parts *parts, uint32_t disk_id);
 
 #ifdef __cplusplus
 }
diff --git a/src/ext4_mbr.c b/src/ext4_mbr.c
index 14fe252..0376545 100644
--- a/src/ext4_mbr.c
+++ b/src/ext4_mbr.c
@@ -59,7 +59,8 @@ struct ext4_part_entry {
 };
 
 struct ext4_mbr {
-	uint8_t bootstrap[446];
+	uint8_t bootstrap[442];
+	uint32_t disk_id;
 	struct ext4_part_entry part_entry[4];
 	uint16_t signature;
 };
@@ -126,7 +127,7 @@ int ext4_mbr_scan(struct ext4_blockdev *parent, struct ext4_mbr_bdevs *bdevs)
 	return r;
 }
 
-int ext4_mbr_write(struct ext4_blockdev *parent, struct ext4_mbr_parts *parts)
+int ext4_mbr_write(struct ext4_blockdev *parent, struct ext4_mbr_parts *parts, uint32_t disk_id)
 {
 	int r;
 	uint64_t disk_size;
@@ -157,6 +158,7 @@ int ext4_mbr_write(struct ext4_blockdev *parent, struct ext4_mbr_parts *parts)
 	struct ext4_mbr *mbr = (void *)parent->bdif->ph_bbuf;
 	memset(mbr, 0, sizeof(struct ext4_mbr));
 
+	mbr->disk_id = disk_id;
 
 	uint32_t cyl_it = 0;
 	for (int i = 0; i < 4; ++i) {
-- 
2.7.4

